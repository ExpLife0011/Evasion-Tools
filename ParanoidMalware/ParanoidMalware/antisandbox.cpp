#include "antisandbox.h"
#include "Helper.h"

antisandbox::antisandbox(void)
{
}


antisandbox::~antisandbox(void)
{
}

void antisandbox::startDetect(){
	printf("========= Checks for AntiSandbox =======\n");
	isCWSandbox();
	isAnubis();
	checkProcess();
	checkFile();
	checkRegistry();
	findWindows();
}

void antisandbox::findWindows(){
	Helper h;
	HWND hnd = FindWindow(L"SandboxieControlWndClass", 0);
	
	if(h.findWindows(L"SandboxieControlWndClass")){
		printf("Anti-Sandbox: Sandboxie exists.\n");
	}
}

void antisandbox::isCWSandbox(){
	bool result = false;
	unsigned char cBuffer;
    unsigned long lProc= (unsigned long)GetProcAddress( GetModuleHandle( L"KERNEL32.dll" ), "CreateProcessA" );

    if( ReadProcessMemory( GetCurrentProcess(), (void *) lProc, &cBuffer, 1, NULL ) ){		
        if( cBuffer==0xE9 ){
			result = true;
        }
    }

	if(result){
		printf("Anti-Sandbox: Is inside CWSandbox.\n");
	}
}

void antisandbox::isAnubis(){
	Helper h;
	int expPID = h.getProcessID("explorer.exe");
	char cFile[MAX_PATH];

	if( strstr(cFile, "C:\\InsideTm\\") ){
		printf("Anti-Sandbox: Is inside Anubis.\n");
	}
}

void antisandbox::checkProcess(){
	Helper h;
	h.isProcessExists("SbieCtrl.exe");
}

void antisandbox::checkFile(){

}

void antisandbox::checkRegistry(){
	Helper h;

	wstring checkString[] = {wstring(L"76487-644-3177037-23510"), 
		wstring(L"55274-640-2673064-23950"), 
		wstring(L"76487-337-8429955-22614")};

	if(h.isRegistryValue(HKEY_LOCAL_MACHINE, TEXT("Software\\Microsoft\\Windows NT\\CurrentVersion\\"), TEXT("ProductId"), checkString, 3)){
			printf("Anti-Sandbox: Process is run in a Sandbox.\n");
	}

}